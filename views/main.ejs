<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ë­˜ê¹Œìš”?</title>
  <link rel="stylesheet" href="/main.css">
</head>
<body>
  <!-- ì–´ì œì˜ ê¸€ (ë„¤ëª¨ ë°•ìŠ¤ + ë‹¤ì‹œ ë³´ì§€ ì•Šê¸°) -->
  <div id="yesterdayBox" class="yesterday" style="display:none;">
    <% if (yesterdayTopPost) { %>
      <div class="post-box center-box">
        <div style="font-weight:bold; font-size:1.2em; margin-bottom:5px;">ì–´ì œì˜ ìš°ìŠ¹</div>
        <% if (yesterdayImage && yesterdayImage.url) { %>
          <div style="margin:10px 0;">
            <img src="<%= yesterdayImage.url %>" alt="ì–´ì œì˜ ì´ë¯¸ì§€" style="max-width:300px; max-height:300px;">
          </div>
        <% } %>
        <div>
          <i style="font-size:1.3em;">"<%= yesterdayTopPost.text %>"</i>
        </div>
        <div><%= yesterdayTopPost.likes %>í‘œ íšë“!</div>
        <button id="hideYesterdayBtn" style="margin-top:10px;">ë‹¤ì‹œ ë³´ì§€ ì•Šê¸°</button>
      </div>
    <% } else { %>
      <div class="post-box center-box">ì–´ì œì˜ ìš°ìŠ¹ ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</div>
    <% } %>
  </div>

  <style>
    .center-box {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
    }
  </style>

  <div class="center">
    <!-- ì•ˆë‚´ë¬¸êµ¬ -->
    <div class="guide-text">ì•„ë˜ ì‚¬ì§„ì„ ë³´ê³  ë“œëŠ” ìƒê°ì„ ììœ ë¡­ê²Œ ì‘ì„±í•´ì£¼ì„¸ìš”.</div>
    <!-- ì˜¤ëŠ˜ì˜ ì´ë¯¸ì§€ -->
    <% if (image && image.url) { %>
      <img src="<%= image.url %>" alt="ì˜¤ëŠ˜ì˜ ì´ë¯¸ì§€">
    <% } else { %>
      <div>ì˜¤ëŠ˜ì˜ ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.</div>
    <% } %>

    <!-- Top3 ì œëª© -->
    <div class="top3-title">ì˜¤ëŠ˜ì˜ Top3</div>
    <!-- Top 3 Posts -->
    <div class="top3-container">
      <% postsTop3.forEach(function(post) { %>
        <div class="post-box" data-id="<%= post._id %>">
          <span><%= post.text %></span>
          <form class="like-form" method="post" action="/posts/<%= post._id %>" style="margin:0;">
            <button type="submit" class="like-btn">ğŸ‘ <span><%= post.likes %></span></button>
          </form>
        </div>
      <% }) %>
    </div>

    <!-- ìƒˆ ê¸€ ì‘ì„± -->
    <form class="new-post-form" id="newPostForm" method="post" action="/posts">
      <input type="text" name="text" id="newPostInput" placeholder="ìƒˆ ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”" required>
      <button type="submit">ì „ì†¡</button>
    </form>

    <!-- Posts -->
    <div class="posts-container" id="postsContainer">
      <% posts.forEach(function(post) { %>
        <div class="post-box" data-id="<%= post._id %>">
          <span><%= post.text %></span>
          <form class="like-form" method="post" action="/posts/<%= post._id %>" style="margin:0;">
            <button type="submit" class="like-btn">ğŸ‘ <span><%= post.likes %></span></button>
          </form>
        </div>
      <% }) %>
    </div>
  </div>

  <script>
    // ì–´ì œì˜ ìš°ìŠ¹ ê¸€ ë‹¤ì‹œ ë³´ì§€ ì•Šê¸° ê¸°ëŠ¥
    function getTodayStr() {
      const d = new Date();
      return d.getFullYear() + '-' + (d.getMonth()+1).toString().padStart(2,'0') + '-' + d.getDate().toString().padStart(2,'0');
    }
    (function() {
      const box = document.getElementById('yesterdayBox');
      const today = getTodayStr();
      if (localStorage.getItem('hideYesterday') === today) {
        box.style.display = 'none';
      } else {
        box.style.display = '';
      }
      const btn = document.getElementById('hideYesterdayBtn');
      if (btn) {
        btn.onclick = function() {
          localStorage.setItem('hideYesterday', today);
          box.style.display = 'none';
        };
      }
    })();

    // ìƒˆ ê¸€ ì‘ì„± AJAX
    document.getElementById('newPostForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      const input = document.getElementById('newPostInput');
      const text = input.value.trim();
      if (!text) return;

      const res = await fetch('/posts', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ text })
      });
      if (res.ok) {
        const post = await res.json();
        // ìƒˆ ê¸€ì„ postsContainer ë§¨ ìœ„ì— ì¶”ê°€
        const container = document.getElementById('postsContainer');
        const div = document.createElement('div');
        div.className = 'post-box';
        div.setAttribute('data-id', post._id);
        div.innerHTML = `
          <span>${post.text}</span>
          <form class="like-form" method="post" action="/posts/${post._id}" style="margin:0;">
            <button type="submit" class="like-btn">ğŸ‘ <span>${post.likes}</span></button>
          </form>
        `;
        container.prepend(div);
        input.value = '';
      } else {
        alert('ê¸€ ì‘ì„± ì‹¤íŒ¨');
      }
    });

    // Like ë²„íŠ¼ AJAX (Top3, posts ëª¨ë‘ ë™ê¸°í™”)
    document.addEventListener('submit', async function(e) {
      if (e.target.classList.contains('like-form')) {
        e.preventDefault();
        const form = e.target;
        const postId = form.action.split('/').pop();
        const res = await fetch(`/posts/${postId}`, { method: 'POST' });
        if (res.ok) {
          const data = await res.json();
          // ê°™ì€ postIdë¥¼ ê°€ì§„ ëª¨ë“  like ìˆ«ì ê°±ì‹  (top3, posts ëª¨ë‘)
          document.querySelectorAll(`.post-box[data-id='${postId}'] .like-btn span`).forEach(function(span) {
            span.textContent = data.likes;
          });
        } else {
          alert('ì¢‹ì•„ìš” ì‹¤íŒ¨');
        }
      }
    });
  </script>
</body>
</html>